<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æŠ–éŸ³å®¢æœé€šè¯</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 30px;
    }
    #callButton, #hangupButton {
      padding: 16px 32px;
      font-size: 20px;
      margin: 10px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
    }
    #callButton {
      background: linear-gradient(135deg, #ff2c55, #ff6b81);
    }
    #hangupButton {
      background: linear-gradient(135deg, #6c757d, #343a40);
    }
    #callButton:disabled, #hangupButton:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #callStatus {
      margin-top: 15px;
      font-size: 18px;
      color: #ccc;
    }
    #notice {
      margin-top: 10px;
      font-size: 14px;
      color: #ffdd57;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ æ­£åœ¨è¿æ¥å®¢æœï¼Œè¯·ä¿æŒé¡µé¢åœ¨å‰å°</h1>

  <button id="callButton" onclick="makeCall()">ğŸ“ å‘¼å«å®¢æœ</button>
  <button id="hangupButton" onclick="hangupCall()" disabled>ğŸ›‘ æŒ‚æ–­</button>

  <div id="callStatus">æœªå‘¼å«</div>
  <div id="notice"></div>

  <audio id="audioRemote" autoplay></audio>
  <audio id="ringAudio" loop src="https://yourdomain.com/ring.mp3"></audio>

  <!-- JsSIP & å·¥å…·åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/devtools-detect@1.0.1/index.min.js"></script>

  <script>
    const ua = new JsSIP.UA({
      sockets: [new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws')],
      uri: 'sip:100110@xin.anjre.cn',
      password: 'Aa6363463@',
      display_name: 'ç½‘é¡µå®¢æˆ·',
      session_timers: false,
    });

    let session = null;
    let isCalling = false;
    const callButton = document.getElementById('callButton');
    const hangupButton = document.getElementById('hangupButton');
    const statusDisplay = document.getElementById('callStatus');
    const ringAudio = document.getElementById('ringAudio');
    const remoteAudio = document.getElementById('audioRemote');
    const notice = document.getElementById('notice');

    ua.start();
    ua.on('registered', () => console.log('âœ… æ³¨å†ŒæˆåŠŸ'));

    function updateStatus(text) {
      statusDisplay.textContent = text;
    }

    window.makeCall = function () {
      if (isCalling) return;
      isCalling = true;
      callButton.disabled = true;
      hangupButton.disabled = false;
      updateStatus("æ­£åœ¨å‘¼å«...");
      notice.textContent = "ğŸ“¢ è¯·ä¿æŒé¡µé¢åœ¨å‰å°";

      // éœ‡åŠ¨å’Œé“ƒå£°
      if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
      ringAudio.play().catch(() => {});

      session = ua.call('sip:80088@xin.anjre.cn', {
        mediaConstraints: { audio: true, video: false },
        rtcOfferConstraints: {
          offerToReceiveAudio: 1,
          offerToReceiveVideo: 0
        }
      });

      session.connection.addEventListener('addstream', function (e) {
        remoteAudio.srcObject = e.stream;
        remoteAudio.play().catch(() => {});
      });

      session.on('progress', () => updateStatus("æŒ¯é“ƒä¸­..."));
      session.on('accepted', () => {
        ringAudio.pause();
        updateStatus("é€šè¯ä¸­");
        notice.textContent = "";
      });
      session.on('ended', () => {
        updateStatus("é€šè¯ç»“æŸ");
        resetUI();
      });
      session.on('failed', () => {
        updateStatus("å‘¼å«å¤±è´¥");
        ringAudio.pause();
        resetUI();
      });
    };

    window.hangupCall = function () {
      if (session) {
        session.terminate();
      }
    };

    function resetUI() {
      isCalling = false;
      callButton.disabled = false;
      hangupButton.disabled = true;
      notice.textContent = "";
      session = null;
    }

    // é¡µé¢åˆ‡æ¢æç¤º
    document.addEventListener("visibilitychange", () => {
      if (document.hidden && isCalling) {
        notice.textContent = "âš ï¸ é¡µé¢åœ¨åå°ï¼Œå¯èƒ½å¬ä¸åˆ°å¯¹æ–¹å£°éŸ³";
      } else if (isCalling) {
        notice.textContent = "ğŸ“¢ è¯·ä¿æŒé¡µé¢åœ¨å‰å°";
      }
    });

    // ç¦»å¼€é¡µé¢å‰æé†’
    window.onbeforeunload = function () {
      if (isCalling) {
        return "å½“å‰æ­£åœ¨é€šè¯ï¼Œç¡®å®šè¦ç¦»å¼€ï¼Ÿ";
      }
    };

    // âœ… åè°ƒè¯•ä»£ç ï¼šç¦æ­¢å³é”®ã€å¿«æ·é”®ã€æ§åˆ¶å°è°ƒè¯•
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' || (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 'i' || e.key === 'I'))) {
        e.preventDefault();
      }
    });
    setInterval(() => {
      if (window.devtools.isOpen) {
        alert('âš ï¸ è¯·ä¸è¦å°è¯•è°ƒè¯•æ­¤é¡µé¢ï¼');
        location.reload();
      }
    }, 1000);
  </script>
</body>
</html>
